+++
title = "go build の引数と docker マルチステージビルド"
date = "2026-01-31"
description = "go build のオプションいつも忘れる"
[taxonomies]
tags = ["golang"]
+++

いつも忘れる go build の引数。最近 Go やってないので久々に Go 書きたくなった。

```zsh
GOARCH=arm64 GOOS=linux CGO_ENABLED=0 go build -trimpath -ldflags='-s -w' -o main main.go
```

main と main.go はお好みに書き換える。

## ポイント

- `CGO_ENABLED=0` で静的リンクにする
- `-trimpath` はバイナリ内にビルド環境のパス情報が含まれることを抑止
- `-ldflags='-s -w'` はシンボルテーブルとデバッグ情報を除外

本番用 Docker マルチステージビルドは以下。 AWS Lambda 用バイナリをビルドして scratch コンテナに投入している。  
scratch をベースにするのは本番のランタイムに余計なものを一切入れたくないため。そのために `GO_ENABLED=0` でバイナリからランタイムへの依存を排除している。

```Dockerfile
FROM golang:1-alpine as builder
RUN apk update && apk add --no-cache ca-certificates && update-ca-certificates
WORKDIR /app
COPY . .
RUN GOARCH=arm64 GOOS=linux CGO_ENABLED=0 go build -trimpath -ldflags="-s -w" -o ./bootstrap ./main.go

FROM scratch
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=builder /app/bootstrap /bootstrap
COPY --from=public.ecr.aws/awsguru/aws-lambda-adapter:0.9.1 /lambda-adapter /opt/extensions/lambda-adapter
ENV PORT=8000
EXPOSE 8000
ENTRYPOINT [ "/bootstrap" ]
```

AWS Lambda Web Adapter も入っているので gin や fiber で作った API サーバをそのまま Lambda に上げられる。Lambda での運用が厳しかった場合は ECS に上げてもそのまま動く。多分。

ビルドコンテキストが main.go の在処であれば改変不要でそのまま使用できる。はず。
